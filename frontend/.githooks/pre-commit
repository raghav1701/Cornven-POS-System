#!/bin/sh
#
# Pre-commit hook to ensure code quality and prevent reliability regressions
#

echo "Running pre-commit checks..."

# Change to frontend directory
cd frontend 2>/dev/null || {
    echo "Error: Could not find frontend directory"
    exit 1
}

# Check if we're in a git repository
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo "Error: Not in a git repository"
    exit 1
 fi

# Function to check if command exists
command_exists() {
    command -v "$1" >/dev/null 2>&1
}

# Check for Node.js
if ! command_exists node; then
    echo "Error: Node.js is not installed"
    exit 1
fi

# Check for npm
if ! command_exists npm; then
    echo "Error: npm is not installed"
    exit 1
fi

# Install dependencies if node_modules doesn't exist
if [ ! -d "node_modules" ]; then
    echo "Installing dependencies..."
    npm install
fi

echo "1. Running TypeScript type check..."
if ! npx tsc --noEmit; then
    echo "❌ TypeScript type check failed"
    exit 1
fi
echo "✅ TypeScript type check passed"

echo "2. Running ESLint..."
if ! npm run lint; then
    echo "❌ ESLint check failed"
    exit 1
fi
echo "✅ ESLint check passed"

echo "3. Checking for potential secrets..."
# Check staged files for potential secrets
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx|js|jsx)$' || true)

if [ -n "$STAGED_FILES" ]; then
    for file in $STAGED_FILES; do
        if [ -f "$file" ]; then
            # Check for potential API keys or secrets
            if grep -q -E '(sk_|pk_|api_key|secret_key|password.*=|token.*=)' "$file"; then
                echo "❌ Potential secret found in $file"
                echo "Please remove secrets before committing"
                exit 1
            fi
        fi
    done
fi
echo "✅ No secrets detected"

echo "4. Checking for console.log statements..."
if [ -n "$STAGED_FILES" ]; then
    for file in $STAGED_FILES; do
        if [ -f "$file" ] && grep -q "console\.log" "$file"; then
            echo "⚠️  Warning: console.log found in $file"
            echo "Consider removing console.log statements before production"
            # Don't fail, just warn
        fi
    done
fi

echo "5. Running build test..."
if ! npm run build; then
    echo "❌ Build failed"
    exit 1
fi
echo "✅ Build test passed"

echo "✅ All pre-commit checks passed!"
exit 0